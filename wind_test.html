<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>AB Wind Particles Test</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <style>
    html, body {
      height: 100%;
      margin: 0;
    }
    #map {
      width: 100%;
      height: 100%;
      position: relative;
    }
    canvas.wind-layer {
      position: absolute;
      top: 0;
      left: 0;
      pointer-events: none; /* let mouse clicks go through to the map */
    }
  </style>
</head>
<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
  // ─────────────────────────────────────────
  // 1) Base map + canvas overlay
  // ─────────────────────────────────────────
  const map = L.map('map').setView([53.5, -113.5], 6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 12,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  const mapDiv = document.getElementById('map');
  const windCanvas = document.createElement('canvas');
  windCanvas.className = 'wind-layer';
  mapDiv.appendChild(windCanvas);
  const windCtx = windCanvas.getContext('2d');

  function resizeCanvas() {
    const rect = mapDiv.getBoundingClientRect();
    windCanvas.width = rect.width;
    windCanvas.height = rect.height;
  }
  window.addEventListener('resize', resizeCanvas);
  map.on('resize move zoom', () => {
    resizeCanvas();
  });
  resizeCanvas();

  map.on('zoomstart movestart', () => {
  windCtx.clearRect(0, 0, windCanvas.width, windCanvas.height);
  });


  // ─────────────────────────────────────────
  // 2) Wind field JSON + simple interpolation
  // ─────────────────────────────────────────
  let windField = null;   // will hold { meta, lats, lons, u, v }
  let particles = [];

  // TODO: adjust this path to wherever your JSON lives
  const WIND_JSON_URL = "data/AB_wind_latest.json";

  fetch(WIND_JSON_URL)
    .then(r => r.json())
    .then(js => {
      windField = js;
      console.log("Loaded wind field:", js.meta);

      initParticles(800);   // your function
    })
    .catch(err => {
      console.error("Failed to load wind field:", err);
    });

  // Nearest-neighbour interpolation of u/v at a given lat/lon.
  // Fine for testing; we can upgrade to bilinear later.
  function interpolateWind(lat, lon) {
    if (!windField) return null;

    const lats = windField.lats;
    const lons = windField.lons;
    const uArr = windField.u; // 2D: [iLat][jLon]
    const vArr = windField.v;

    const nlat = lats.length;
    const nlon = lons.length;
    if (!nlat || !nlon) return null;

    // Find nearest latitude index
    let bestI = 0;
    let bestLatDiff = Infinity;
    for (let i = 0; i < nlat; i++) {
      const d = Math.abs(lat - lats[i]);
      if (d < bestLatDiff) {
        bestLatDiff = d;
        bestI = i;
      }
    }

    // Find nearest longitude index
    let bestJ = 0;
    let bestLonDiff = Infinity;
    for (let j = 0; j < nlon; j++) {
      const d = Math.abs(lon - lons[j]);
      if (d < bestLonDiff) {
        bestLonDiff = d;
        bestJ = j;
      }
    }

    const u = uArr[bestI]?.[bestJ];
    const v = vArr[bestI]?.[bestJ];

    if (typeof u !== "number" || typeof v !== "number" || !isFinite(u) || !isFinite(v)) {
      return null;
    }
    return { u, v };
  }

  // ─────────────────────────────────────────
  // 3) Your particle functions (slotted here)
  // ─────────────────────────────────────────

  function initParticles(n = 500) {
    particles = [];
    const bounds = map.getBounds();

    for (let i = 0; i < n; i++) {
      const lat = bounds.getSouth() + Math.random() * (bounds.getNorth() - bounds.getSouth());
      const lon = bounds.getWest()  + Math.random() * (bounds.getEast()  - bounds.getWest());

      particles.push({
        lat,
        lon,
        age: Math.random() * 100
      });
    }
  }

  function evolveParticles(dtSeconds = 60) {
    if (!particles.length) return;

    const bounds = map.getBounds();

    for (const p of particles) {
      p.age += 1;
      if (p.age > 200) {
        // respawn
        p.age = 0;
        p.lat = bounds.getSouth() + Math.random() * (bounds.getNorth() - bounds.getSouth());
        p.lon = bounds.getWest()  + Math.random() * (bounds.getEast()  - bounds.getWest());
        continue;
      }

      const w = interpolateWind(p.lat, p.lon);
      if (!w) {
        p.age = 999; // kill / respawn soon
        continue;
      }

      // Crude: speed [m/s] * dt [s] -> displacement [m], then to degrees
      const EARTH_R = 6371000;
      const dlat = (w.v * dtSeconds) / EARTH_R * (180 / Math.PI);
      const dlon = (w.u * dtSeconds) / (EARTH_R * Math.cos(p.lat * Math.PI / 180)) * (180 / Math.PI);

      // Move FORWARD in time (trajectories show where air is going)
      p.lat += dlat;
      p.lon += dlon;

      if (!bounds.contains([p.lat, p.lon])) {
        p.age = 999;
      }
    }
  }

  function drawParticles() {
    windCtx.clearRect(0, 0, windCanvas.width, windCanvas.height);
    windCtx.globalAlpha = 0.6;
    windCtx.strokeStyle = "#00ffff";
    windCtx.lineWidth = 1;

    for (const p of particles) {
      const latlng = L.latLng(p.lat, p.lon);
      const pt = map.latLngToContainerPoint(latlng);

      windCtx.beginPath();
      // short streak – you can lengthen this later
      windCtx.moveTo(pt.x, pt.y);
      windCtx.lineTo(pt.x - 2, pt.y - 2);
      windCtx.stroke();
    }
  }

  function frame() {
    requestAnimationFrame(frame);
    if (!windField || !particles.length) return;
    evolveParticles(10);  // 60 seconds per frame (visual scale)
    drawParticles();
  }
  frame();

  // Re-seed particles when you drag/zoom a lot
  map.on('moveend zoomend', () => {
    if (windField) {
      initParticles(800);
    }
  });
</script>
</body>
</html>
